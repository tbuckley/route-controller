<!--
/**
 * @module Route UI Elements
 */
/**
 * route-ui-tile
 *
 * Example:
 *
 *     <route-ui-tile>
 *       ...
 *     </route-ui-tile>
 *
 * @class route-ui-tile
 */
/**
 * Fired when the tile is tilted in some direction.
 *
 * @event route-ui-tile-[left/right/top/bottom]
 */
/**
 * Fired when the tile is pressed.
 *
 * @event route-ui-tile-press
 */
/**
 * Fired when the tile is released.
 *
 * @event route-ui-tile-release
 */
-->
<link rel="import" href="../../components/polymer/polymer.html">
<script type="text/javascript" src="../../components/hammerjs/hammer.js"></script>

<polymer-element name="route-ui-tile" attributes="maxRotation" touch-action="none" on-tap="{{tap}}">
  <template>
    <link rel="stylesheet" href="route-ui-tile.css">
    <div id="tile">
      <content></content>
    </div>
  </template>
  <script>
    Polymer('route-ui-tile', {
      /**
       * Sets how much the tile should be able to rotate around the X/Y axes, in degrees.
       *
       * @attribute maxRotation
       * @type int
       * @default 15
       */
      maxRotation: 15,

      ready: function() {
        this.hammer = Hammer(this, {
          hold: false,
          transform: false,
          tap: false,
          tap_always: false,
        });
        // this.hammer.on("touch", this.touch.bind(this));
        // this.hammer.on("drag", this.drag.bind(this));
        // this.hammer.on("release", this.release.bind(this));
        // this.hammer.on("tap", this.tap.bind(this));
        // this.hammer.on("swipe", this.swipe.bind(this));
      },
      tap: function(e) {
        this.fire("route-ui-tile-tap");
      },
      swipe: function(e) {
        this.fire("route-ui-tile-swipe"+e.gesture.direction);
      },
      animate: function(percentX, percentY, raised) {
        var bound = function(value, min, max) {
          if(value < min) return min;
          if(value > max) return max;
          return value;
        };

        var rotationX = bound(percentX, -1, 1) * 15,
            rotationY = bound(percentY, -1, 1) * 15;

        var s = this.$.tile.style;
        var transform = raised ? "translate3d(0,0,20px)" : "";
        var rotate = "rotateX("+rotationY+"deg) rotateY("+rotationX+"deg)";

        s.webkitTransform = s.mozTransform = s.msTransform = s.transform =
            transform + " " + rotate;
      },
      updateDimensions: function() {
        this.dimensions = {};
        var x = 0, y = 0;
        for(var el = this; el != null; x += el.offsetLeft, y += el.offsetTop, el = el.offsetParent);
        this.dimensions.left = x;
        this.dimensions.top = y;
        this.dimensions.width = this.offsetWidth;
        this.dimensions.height = this.offsetHeight;
        this.dimensions.centerX = this.dimensions.left + (this.dimensions.width / 2);
        this.dimensions.centerY = this.dimensions.top + (this.dimensions.height / 2);
      },
      updateStartingPosition: function(clientX, clientY) {
        this.start = {
          x: clientX,
          y: clientY,
        };
      },
      updateLatestPosition: function(clientX, clientY) {
        var distX = clientX - this.start.x,
            distY = clientY - this.start.y;

        this.latest = {
          x: clientX,
          y: clientY,
          percent: {
            x: (clientX - this.dimensions.centerX) * 2 / this.dimensions.width,
            y: -(clientY - this.dimensions.centerY) * 2 / this.dimensions.height,
          },
          distance: Math.sqrt(distX*distX + distY*distY),
        };
      },
      touch: function(event, details, sender) {
        event.preventDefault();

        this.fire("route-activity");
        var clientX = event.gesture.center.pageX;
        var clientY = event.gesture.center.pageY;

        this.updateDimensions();
        this.updateStartingPosition(clientX, clientY);
        this.updateLatestPosition(clientX, clientY);
        this.animate(0, 0, true);
        this.$.tile.classList.add('dragging');
      },
      drag: function(event, details, sender) {
        event.preventDefault();

        this.fire("route-activity");
        var clientX = event.gesture.center.pageX;
        var clientY = event.gesture.center.pageY;
        this.updateLatestPosition(clientX, clientY);
        this.animate(this.latest.percent.x, this.latest.percent.y, true);
      },
      release: function(event, details, sender) {
        event.preventDefault();
        if("gesture" in event) {
          this.fire("route-activity");
          this.$.tile.classList.remove('dragging');
          this.animate(0, 0, false);
        }
      },
    });
  </script>
</polymer-element>