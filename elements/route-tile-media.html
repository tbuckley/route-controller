<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="./route-ui-tile/route-ui-tile.html">
<link rel="import" href="polymer-image-search.html">

<polymer-element name="route-tile-media" attributes="messenger">
  <template>
    <link rel="stylesheet" href="css/route-tile-media.css">

    <polymer-image-search id="imageSearch" query="{{query}}" on-load="{{loadHandler}}"></polymer-image-search>

    <polymer-flex-layout vertical></polymer-flex-layout>
    <route-ui-tile id="tile" flex>
      <div class="album-name">{{name}}</div>
      <div id="artwork">
        <!-- <img id="defaultArtwork" src="{{artwork}}" /> -->
      </div>
    </route-ui-tile>

  </template>
  <script>
    (function() {

      Polymer("route-tile-media", {
        ready: function() {},
        enteredView: function() {
          this.messenger.on("Sonos.Main.TrackInfo", function(data) {
            this.name = data.name;
            this.query = data.artist + " " + data.album + " album art";
          }.bind(this));
          this.messenger.emit("getState", "Sonos.Main.TrackInfo");

          // this.query = "led zeppelin IV";

          this.$.tile.addEventListener("center", function() {
            this.messenger.emit("DeviceEvent", "PlayPause", {});
          }.bind(this));
          this.$.tile.addEventListener("left", function() {
            this.messenger.emit("DeviceEvent", "NextTrack", {});
          }.bind(this));
          this.$.tile.addEventListener("right", function() {
            this.messenger.emit("DeviceEvent", "PrevTrack", {});
          }.bind(this));
        },
        loadHandler: function(error, img, sender) {
          while(this.$.artwork.hasChildNodes()) {
            this.$.artwork.removeChild(this.$.artwork.lastChild);
          }
          this.$.artwork.appendChild(img);

          var dim = this.offsetWidth - 8;
          if(img.width > img.height) {
            var width = (dim * img.width / img.height),
                offset = -Math.floor((width - dim) / 2);

            img.style.position = "relative";
            img.style.height = dim + "px";
            img.style.width = "auto";
            img.style.left = offset + "px";
          } else {
            var height = (dim * img.height / img.width),
                offset = -Math.floor((height - dim) / 2);

            img.style.position = "relative";
            img.style.width = dim + "px";
            img.style.height = "auto";
            img.style.top = offset + "px";
          }
        }
      });
    })();
  </script>
</polymer-element>