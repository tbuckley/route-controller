<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/polymer-flex-layout/polymer-flex-layout.html">
<link rel="import" href="route-tile.html">
<link rel="import" href="polymer-image-search.html">

<polymer-element name="route-tile-lights" attributes="messenger lights name">
  <template>
    <link rel="stylesheet" href="css/route-tile-lights.css">

    <route-tile id="tile">
      <div style="position: absolute; left:0;right:0;top:0;bottom:0;">
        <polymer-flex-layout vertical></polymer-flex-layout>
        <div flex></div>
        <div style="height: 128px;">
          <polymer-flex-layout></polymer-flex-layout>
          <div flex></div>
          <div style="width: 128px; position: relative;">
            <div class="left">Hue</div>
            <div class="right">Hue</div>
            <div class="top">Bright</div>
            <div class="bottom">Dim</div>
            <div class="icon">
              <polymer-flex-layout vertical></polymer-flex-layout>
              <div flex></div>
              <div class="name">{{name}}</div>
              <div flex></div>
            </div>
          </div>
          <div flex></div>
        </div>
        <div flex></div>
    </div>
    </route-tile>

  </template>
  <script>
    (function() {

      Polymer("route-tile-lights", {
        brightness: 0,
        state: false,

        ready: function() {},
        enteredView: function() {
          this.messenger.on("Hue.LightInfo", function(data) {
            console.log("LIGHTS", data);
            for(key in data) {
              if(data.hasOwnProperty(key) && key != "stateUpdatedTime") {
                var light = data[key];
                if(light.name.match(this.lights)) {
                  var brightness = light.state.bri / 255,
                      state = light.state.on;
                  this.brightness = Math.max(this.brightness, brightness);
                  this.state = this.state || state;
                }
              }
            }
            this.update();
          }.bind(this));

          this.messenger.emit("getState", "Hue.LightInfo");

          this.$.tile.addEventListener("center", function() {
            this.state = !this.state;
            this.update();
          }.bind(this));
          this.$.tile.addEventListener("top", function() {
            var bri = Math.min(1, this.brightness + 0.05);
            if(bri != this.brightness) {
              this.brightness = bri;
              this.update();
            }
          }.bind(this));
          this.$.tile.addEventListener("bottom", function() {
            var bri = Math.max(0, this.brightness - 0.05);
            if(bri != this.brightness) {
              this.brightness = bri;
              this.update();
            }
          }.bind(this));
          this.$.tile.addEventListener("tilt", function(e, details, sender) {
            console.log(details);
          }.bind(this));
        },
        update: function() {
          this.messenger.emit("DeviceEvent", "SetLights", {
            bulbName: this.lights,
            bri: this.brightness,
            state: this.state,
            duration: 0.1,
          });
        },
      });
    })();
  </script>
</polymer-element>