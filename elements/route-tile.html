<link rel="import" href="../components/polymer/polymer.html">

<polymer-element name="route-tile" attributes="">
  <template>
    <link rel="stylesheet" href="css/route-tile.css">
    <div id="tile" class="tile">
      <content></content>
    </div>
  </template>
  <script>
    (function() {

      function getPos(el) {
        // yay readability
        var orig = el;
        for (var lx=0, ly=0;
             el != null;
             lx += el.offsetLeft, ly += el.offsetTop, el = el.offsetParent);
        return {x: lx, y: ly, width: orig.offsetWidth, height: orig.offsetHeight};
      }

      function bound(val, min, max) {
        if(val < min) return min;
        if(val > max) return max;
        return val;
      }

      function calculateTransform(coords, dims) {
        var perX = ((coords.x - dims.x) * 2 / dims.width) - 1,
            perY = ((coords.y - dims.y) * 2 / dims.height) - 1,
            degX = bound(perX * 15, -15, 15),
            degY = bound(perY * -15, -15, 15);

        var rotY = " rotateY("+degX+"deg)",
            rotX = " rotateX("+degY+"deg)";
        return "translate3d(0,0,20px)" + rotY + rotX;
      }

      Polymer("route-tile", {
        ready: function() {
          if ('ontouchstart' in document.documentElement) {
            this.events = {
              start: "touchstart",
              end: "touchend",
              move: "touchmove"
            };
          } else {
            this.events = {
              start: "mousedown",
              end: "mouseup",
              move: "mousemove"
            };
          }

          this.$.tile.addEventListener(this.events.start, this.startHandler.bind(this));
        },
        enteredView: function() {},
        startHandler: function(e) {
          e.preventDefault();
          this.dims = getPos(this.$.tile);

          var coords = {
            x: e.clientX || e.touches[0].clientX,
            y: e.clientY || e.touches[0].clientY,
          };
          this.coords = coords;
          var transform = calculateTransform(coords, this.dims);

          this.style.zIndex = 20;
          var anim = new Animation(this.$.tile, [
            {transform: "translateZ(0px)"},
            {transform: transform},
          ], {duration: 0.1});
          var player = document.timeline.play(anim);

          this.moveHandler = this.moveHandler.bind(this);
          document.addEventListener(this.events.move, this.moveHandler);

          this.upHandler = this.endHandler.bind(this);
          document.addEventListener(this.events.end, this.upHandler);
        },
        moveHandler: function(e) {
          e.preventDefault();

          var coords = {
            x: e.clientX || e.touches[0].clientX,
            y: e.clientY || e.touches[0].clientY,
          }
          this.coords = coords;

          var transform = calculateTransform(coords, this.dims);
          this.$.tile.style._style.webkitTransform = transform;
        },
        endHandler: function(e) {
          e.preventDefault();

          document.removeEventListener(this.events.move, this.moveHandler);
          document.removeEventListener(this.events.end, this.upHandler);

          var dims = this.dims,
              coords = this.coords;
          var perX = ((coords.x - dims.x) * 2 / dims.width) - 1,
            perY = ((coords.y - dims.y) * 2 / dims.height) - 1;

          if(perX < .3 && perX > -.3 && perY > -0.3 && perY < .3) {
            console.log("CENTER");
            this.fire("center");
          } else if(perX > .3 && perY > -0.3 && perY < .3) {
            console.log("RIGHT");
            this.fire("right");
          } else if(perX < -.3 && perY > -0.3 && perY < .3) {
            console.log("LEFT");
            this.fire("left");
          } else if(perX < .3 && perX > -.3 && perY < -0.3) {
            console.log("TOP");
            this.fire("top");
          } else if(perX < .3 && perX > -.3 && perY > 0.3) {
            console.log("BOTTOM");
            this.fire("bottom");
          }

          var anim = new Animation(this.$.tile, [
            {transform: this.$.tile.style._style.webkitTransform},
            {transform: "translateZ(0px)"}
          ], {duration: .5});
          anim.onend = function() {
            this.style.zIndex = 0;
          }.bind(this);
          var player = document.timeline.play(anim);
        },
      });
    })();
  </script>
</polymer-element>