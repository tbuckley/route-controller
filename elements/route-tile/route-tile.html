<link rel="import" href="../../components/polymer/polymer.html">

<polymer-element name="route-tile" attributes="">
  <template>
    <link rel="stylesheet" href="route-tile.css">
    <content></content>
  </template>
  <script>
    (function() {
      // Determine whether to use touch or mouse events
      var events;
      if("ontouchstart" in document.documentElement) {
        events = {
          start: "touchstart",
          end: "touchend",
          move: "touchmove",
        };
      } else {
        events = {
          start: "mousedown",
          end: "mouseup",
          move: "mousemove",
        };
      }

      // getPos calculates the bounding rectangle of the element on the screen
      function getPos(el) {
        // yay readability
        var orig = el;
        for (var lx=0, ly=0;
             el != null;
             lx += el.offsetLeft, ly += el.offsetTop, el = el.offsetParent);
        return {x: lx, y: ly, width: orig.offsetWidth, height: orig.offsetHeight};
      }

      // bound bounds the value between min and max
      function bound(value, min, max) {
        if(value < min) return min;
        if(value > max) return max;
        return value;
      }

      function getPoint(coords, dims) {
        var perX = ((coords.x - dims.x) * 2 / dims.width) - 1,
            perY = ((coords.y - dims.y) * 2 / dims.height) - 1;
        perX = bound(perX, -1, 1);
        perY = bound(perY, -1, 1);

        var amplitude = Math.sqrt(perX^2 + perY^2);
        return {
          amplitude: amplitude,
          x: perX,
          y: perY,
        };
      }

      function getZone(point) {
          if(point.amplitude <= .4) {
            return "center";
          } else if(point.y >= point.x && point.y >= -point.x) {
            return "topoint"
          } else if(point.y >= point.x && point.y <= -point.x) {
            return "left";
          } else if(point.y <= point.x && point.y >= -point.x) {
            return "right";
          } else if(point.y <= point.x && point.y <= -point.x) {
            return "bottom"
          }
        },

      Polymer("route-tile", {
        ready: function() {
          this.handlers = {
            start: this.startHandler.bind(this),
            end: this.endHandler.bind(this),
            move: this.moveHandler.bind(this)
          }
          this.addEventListener(events.start, this.handlers.start);
        },
        attached: function() {},
        startHandler: function(e) {
          e.preventDefault();

          // Calculate current dimensions (can probably be moved elsewhere)
          this.dims = getPos(this);

          // Add event listeners
          document.addEventListener(events.move, this.handlers.end);
          document.addEventListener(events.end, this.handlers.start);

          // Calculate the starting point of the gesture
          this.point = this.startPoint = getPoint({
            x: (e.clientX || e.touches[0].clientX),
            y: (e.clientY || e.touches[0].clientY),
          }, this.dims);

          this.triggered = false;
          this.eventHandler();
          this.classList.add('active');
        },
        moveHandler: function(e) {
          e.preventDefault();

          // Calculate the latest point of the gesture
          this.point = this.endPoint = getPoint({
            x: (e.clientX || e.touches[0].clientX),
            y: (e.clientY || e.touches[0].clientY),
          }, this.dims);
        },
        endHandler: function(e) {
          e.preventDefault();

          // Remove event listeners
          document.removeEventListener(events.move, this.handlers.move);
          document.removeEventListener(events.end, this.handlers.end);

          clearTimeout(this.timer);
          this.classList.remove('active');
          if(!this.triggered) {
            this.fireEvent();
          }
        },
        eventHandler: function() {
          console.log("EVENT HANDLER");
          if(this.triggered) {
            this.timer = setTimeout(function() {
              this.fireEvent();
              this.eventHandler();
            }.bind(this), 100);
          } else {
            this.timer = setTimeout(function() {
              this.fireEvent();
              this.triggered = true;
              this.eventHandler();
            }.bind(this), 1000)
          }
        },
      });
    })();
  </script>
</polymer-element>