<link rel="import" href="../../components/polymer/polymer.html">

<polymer-element name="route-tile" attributes="">
  <script>
    (function() {
      // Determine whether to use touch or mouse events
      var events, supportsTouch;
      supportsTouch = "ontouchstart" in document.documentElement;
      events = {
        start: supportsTouch ? "touchstart" : "mousedown",
        end:   supportsTouch ? "touchend"   : "mouseup",
        move:  supportsTouch ? "touchmove"  : "mousemove",
      };

      // getPos calculates the bounding rectangle of the element on the screen
      function getPos(el) {
        // yay readability
        var orig = el;
        for (var lx=0, ly=0;
             el != null;
             lx += el.offsetLeft, ly += el.offsetTop, el = el.offsetParent);
        return {x: lx, y: ly, width: orig.offsetWidth, height: orig.offsetHeight};
      }

      // bound bounds the value between min and max
      function bound(value, min, max) {
        if(value < min) return min;
        if(value > max) return max;
        return value;
      }

      function getPoint(coords, dims) {
        console.log(coords.x, coords.y, dims.x, dims.y, dims.width, dims.height);
        var perX = ((coords.x - dims.x) * 2 / dims.width) - 1,
            perY = ((coords.y - dims.y) * 2 / dims.height) - 1;
        perX = bound(perX, -1, 1);
        perY = -bound(perY, -1, 1); /* Negate to get normal coord system */

        var amplitude = Math.sqrt(perX*perX + perY*perY);
        return {
          amplitude: amplitude,
          x: perX,
          y: perY,
        };
      }

      function getZone(point) {
        if(point.amplitude <= .4) return "center";
        if(point.y >= point.x) {
          return point.y >= -point.x ? "top" : "left";
        }
        return point.y >= -point.x ? "right" : "bottom";
      };

      Polymer("route-tile", {
        ready: function() {
          this.handlers = {
            start: this.startHandler.bind(this),
            end: this.endHandler.bind(this),
            move: this.moveHandler.bind(this)
          }
          this.addEventListener(events.start, this.handlers.start);
        },
        startHandler: function(e) {
          console.log("start");
          e.preventDefault();

          // Calculate current dimensions (can probably be moved elsewhere)
          this.dims = getPos(this);

          // Add event listeners
          document.addEventListener(events.move, this.handlers.move);
          document.addEventListener(events.end, this.handlers.end);

          // Calculate the starting point of the gesture
          this.point = this.startPoint = getPoint({
            x: (e.clientX || e.touches[0].clientX),
            y: (e.clientY || e.touches[0].clientY),
          }, this.dims);

          this.zone = getZone(this.point);

          this.triggered = false;
          this.eventHandler();
          this.classList.add('active');
        },
        moveHandler: function(e) {
          console.log("move");
          e.preventDefault();

          // Calculate the latest point of the gesture
          this.point = this.endPoint = getPoint({
            x: (e.clientX || e.touches[0].clientX),
            y: (e.clientY || e.touches[0].clientY),
          }, this.dims);

          this.zone = getZone(this.point);

          this.fire("_move", this.zone);
        },
        endHandler: function(e) {
          console.log("end");
          e.preventDefault();

          // Remove event listeners
          document.removeEventListener(events.move, this.handlers.move);
          document.removeEventListener(events.end, this.handlers.end);

          this.classList.remove('active');
          this.asyncFire(this.zone);
        },
      });
    })();
  </script>
</polymer-element>