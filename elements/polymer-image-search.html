<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/polymer-google-jsapi/polymer-google-jsapi.html">

<polymer-element name="polymer-image-search" attributes="query">
  <template>
    <polymer-google-jsapi id="jsapi"></polymer-google-jsapi>
  </template>
  <script>
    (function() {

      var BadURLs = {};

      function Loader(results, callback) {
        this.results = results;
        this.callback = callback;

        this.img = document.createElement("img");
        this.handlers = {
          error: this.handleError.bind(this),
          load: this.handleLoad.bind(this),
        }
        this.img.addEventListener("error", this.handlers.error);
        this.img.addEventListener("load", this.handlers.load);

        this.resultIndex = null;
        this.pickBestResult();
      }
      Loader.prototype.pickBestResult = function() {
        this.resultIndex = this.resultIndex === null ? 0 : this.resultIndex + 1;
        if(this.resultIndex < this.results.length) {
          this.result = this.results[this.resultIndex];
          this.img.src = this.result.url;
        } else {
          console.log("ERROR: No more results to load");
        }
      };
      Loader.prototype.handleError = function() {
        this.pickBestResult();
      };
      Loader.prototype.handleLoad = function() {
        this.img.removeEventListener("error", this.handlers.error);
        this.img.removeEventListener("load", this.handlers.load);
        this.callback(this.img);
      };

      function Searcher() {
        this.search = new google.search.ImageSearch();
      }
      Searcher.prototype.execute = function(query, cb) {
        this.search.setSearchCompleteCallback(this, this.handleSearch, [cb]);
        this.search.execute(query);
      };
      Searcher.prototype.handleSearch = function(cb) {
        var results = this.search.results;
        new Loader(results, cb);
      }

      Polymer("polymer-image-search", {
        loaded: false,
        ready: function() {},
        enteredView: function() {
          this.$.jsapi.addEventListener('polymer-google-jsapi-loaded', function() {
            google.setOnLoadCallback(this.searchLoaded.bind(this));
            google.load("search", "1");
          }.bind(this));
        },
        searchLoaded: function() {
          this.loaded = true;
          if(this.query != null && this.query != "") {
            this.queryChanged(this.query, this.query);
          }
        },
        queryChanged: function(oldQuery, newQuery) {
          if(this.loaded) {
            var searcher = new Searcher();
            searcher.execute(newQuery, function(img) {
              this.fire("load", img);
            }.bind(this));
          } else {
            console.log("SEARCH NOT LOADED");
          }
        },
      });
    })();
  </script>
</polymer-element>