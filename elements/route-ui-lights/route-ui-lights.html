<!--
Copyright 2013 The Polymer Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->

<!--
/**
 * @module Route UI Elements
 */
/**
 * route-ui-lights
 *
 * Example:
 *
 *     <route-ui-lights lights="(1|2)" name="Lights"></route-ui-lights>
 *
 * @class route-ui-lights
 */
-->
<link rel="import" href="../../components/polymer/polymer.html">
<link rel="import" href="../../components/polymer-flex-layout/polymer-flex-layout.html">
<link rel="import" href="../route-ui-tile/route-ui-tile.html">
<link rel="import" href="../route-ui-message/route-ui-message.html">

<polymer-element name="route-ui-lights" attributes="messenger lights name">
  <template>
    <link rel="stylesheet" href="route-ui-lights.css">

    <route-ui-message id="message">
      <polymer-flex-layout vertical></polymer-flex-layout>
      <div flex></div>
      <div>{{brightness}}</div>
      <div flex></div>
    </route-ui-message>

    <route-ui-tile id="tile" autofire autofireInterval="300"
        on-route-ui-tile-top="{{topHandler}}" on-route-ui-tile-bottom="{{bottomHandler}}"
        on-route-ui-tile-center="{{centerHandler}}" on-route-ui-tile-release="{{update}}">

      <div style="height: 100%">
        <polymer-flex-layout vertical></polymer-flex-layout>

        <div flex></div>
        <div style="width: 128px; height: 128px; margin: auto;position: relative;">
          <div class="left">Hue</div>
          <div class="right">Hue</div>
          <div class="top">Bright</div>
          <div class="bottom">Dim</div>
          <div class="icon">
            <polymer-flex-layout vertical></polymer-flex-layout>
            <div flex></div>
            <div class="name">{{name}}</div>
            <div flex></div>
          </div>
        </div>
        <div flex></div>
      </div>

    </route-ui-tile>
  </template>
  <script>
    Polymer('route-ui-lights', {
      /**
       * Name to display on the tile
       *
       * @attribute name
       * @type string
       * @default "Lights"
       */
      name: "Lights",
      /**
       * Regex used to match the lights to control
       *
       * @attribute lights
       * @type regex
       * @default null
       */
      lights: null,

      brightness: 100,
      state: false,

      attached: function() {
        this.messenger.on("Hue.LightInfo", function(data) {
          for(key in data) {
            if(data.hasOwnProperty(key) && key != "stateUpdatedTime") {
              var light = data[key];
              if(light.name.match(this.lights)) {
                var brightness = Math.floor(light.state.bri * 20 / 255) * 5,
                    state = light.state.on;
                this.brightness = Math.max(this.brightness, brightness);
                this.state = this.state || state;
              }
            }
          }
          // this.update();
        }.bind(this));

        this.messenger.emit("getState", "Hue.LightInfo");
      },
      update: function() {
        this.messenger.emit("DeviceEvent", "SetLights", {
          bulbName: this.lights,
          bri: this.brightness / 100,
          state: this.state,
          duration: 0.5,
        });
      },
      centerHandler: function(event, detail, sender) {
        this.state = !this.state;
      },
      topHandler: function(event, detail, sender) {
        this.brightness = Math.min(100, this.brightness + 5);
        this.$.message.show();
      },
      bottomHandler: function(event, detail, sender) {
        this.brightness = Math.max(0, this.brightness - 5);
        this.$.message.show();
      },
    });
  </script>
</polymer-element>